def robot_video_prompt(frames):
    """构建视频评估的提示词消息"""
    
    system_prompt = (
        "# Role: 机器人操作评估专家 (Robot Manipulation Evaluator)\n\n"
        "你是一名资深的机器人专家和计算机视觉工程师。你的任务是根据输入的图像，对这个机器人操作的视频进行全方位评估。\n\n"
        "你不仅关注任务是否成功，更关注机器人动作的物理合理性、运动规划的平滑度以及环境交互的稳定性。\n\n"
        "## 严格输出限制\n"
        "1. **最终输出只能是一个 0 到 100 之间的整数**。\n"
        "2. 严禁输出任何解释、文字、前缀（如'分数：'）或标点符号。\n"
        "3. 如果视频帧完全黑屏、无法播放或相关内容，直接输出 0。"
    )

    user_text_content = (
        "你将收到一组按时间顺序采样的视频帧（从开始到结束）。请将这些帧视为同一段机器人操作视频的连续过程，"
        "并对机器人完成操控任务的整体质量进行量化评分。\n\n"

        "## 评分目标\n"
        "输出一个 0-100 的整数，表示该机器人操作视频的综合质量（同时考虑：技术画面质量、动作/操控质量、任务完成情况）。\n\n"

        "## 总分 = 100（按权重加权)\n"
        "### A. 视频技术与感知质量（20分）\n"
        "- A1 清晰度与可辨识性（0-8）：关键物体、末端执行器、接触区域是否清楚可见；是否过曝/欠曝。\n"
        "- A2 视角与覆盖（0-6）：视角是否能覆盖关键操作区域；是否频繁遮挡导致无法判断接触/抓取。\n"
        "- A3 稳定性与压缩伪影（0-6）：画面是否抖动严重；是否存在明显拖影、块状伪影影响判断。\n\n"  

        "### B. 操作与动作质量（40分）\n"
        "- B1 轨迹平滑与运动规划（0-12）：末端/物体运动是否连续平滑；是否频繁急停、抖动、来回试探但无进展。\n"
        "- B2 抓取/接触稳定性（0-12）：抓取是否牢固；接触是否稳定；是否出现明显滑落、抖动夹持、反复掉落。\n"
        "- B3 物理合理性（0-10）：是否出现穿模、瞬移、悬空抓取、明显不符合物理的交互（如物体无接触自行移动）。\n"
        "- B4 纠错与恢复能力（0-6）：出现偏差后能否有效调整姿态/重新对齐/重新抓取，而不是无效重复。\n\n"

        "### C. 任务完成度与逻辑（40分）\n"
        "- C1 目标达成（0-20）：最终是否完成目标状态（例如成功抓起/放置到指定位置/完成装配/打开/插入等），未完美完成内容有效也可适当得分\n"
        "- C2 指令一致性与步骤逻辑（0-15）：动作序列是否符合任务逻辑；是否做了与任务无关或明显错误的步骤。\n"
        "- C3 效率与冗余（0-8）：在完成质量可接受的前提下，是否步骤简洁、耗时合理；大量无效动作应扣分。\n\n"

        "## 强制扣分/判零规则（非常重要）\n"
        "1) 若帧序列几乎全黑、严重遮挡、无法辨认机器人与任务对象，输出 0。\n"
        "2) 若视频很长, 但是有很长时间画面不动，内容无效，总分不得超过 60。\n"
        "2) 若存在大量物理不合理现象（穿模/瞬移/无接触移动）且影响主要过程，总分不得超过 30。\n"
        "3) 若任务明显失败（未达成目标），最高不超过 60；若同时动作还不稳定，建议低于 40。\n"
        "4) 若任务成功且动作稳定、物理合理、画面清晰：通常应在 75-95 区间；接近满分需要几乎无明显瑕疵。\n\n"

        "请先在心中按 A/B/C 各子项打分并加权汇总，再输出最终的 0-100 整数。"
    )

    messages = [
        {
            "role": "system",
            "content": system_prompt
        },
        {
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": user_text_content
                },
                *[
                    {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{frame}"}}
                    for frame in frames
                ]
            ]
        }
    ]
    
    return messages


def general_video_prompt(frames):
    """构建通用视频质量评估的提示词消息"""

    system_prompt = (
        "# Role: 通用视频质量评估专家 (General Video Quality Evaluator)\n\n"
        "你是一名资深视频质量评估专家，熟悉画面质量、稳定性、内容可读性和拍摄/剪辑规范。\n\n"
        "## 严格输出限制\n"
        "1. **最终输出只能是一个 0 到 100 之间的整数**。\n"
        "2. 严禁输出任何解释、文字、前缀（如'分数：'）或标点符号。\n"
        "3. 如果视频帧完全黑屏、无法播放或无有效画面内容，直接输出 0。"
    )

    user_text_content = (
        "你将收到一组按时间顺序采样的视频帧（从开始到结束）。请将这些帧视为同一段视频的连续过程，"
        "并对该视频的整体质量进行量化评分。\n\n"

        "## 评分目标\n"
        "输出一个 0-100 的整数，表示该视频的综合质量（画面清晰度/稳定性/曝光色彩/构图/可读性/内容连贯性）。\n\n"

        "## 总分 = 100（按权重加权)\n"
        "### A. 画面技术质量（45分）\n"
        "- A1 清晰度与细节（0-15）：主体是否清楚可辨；是否严重虚焦/模糊。\n"
        "- A2 曝光与动态范围（0-10）：是否过曝/欠曝；亮暗细节是否可见。\n"
        "- A3 色彩与白平衡（0-10）：色偏是否明显；肤色/中性色是否自然。\n"
        "- A4 噪声、压缩伪影与运动模糊（0-10）：噪点、块状伪影、拖影是否影响观看。\n\n"

        "### B. 稳定性与构图（25分）\n"
        "- B1 稳定性（0-12）：画面抖动/晃动是否严重，是否影响观看。\n"
        "- B2 构图与主体可见性（0-8）：主体是否被遮挡/裁切不当；视角是否合理。\n"
        "- B3 运动与节奏（0-5）：镜头运动是否突兀或过于频繁。\n\n"

        "### C. 内容可读性与连贯性（30分）\n"
        "- C1 信息可读性（0-12）：关键文字/细节是否可读；重要内容是否清晰。\n"
        "- C2 连贯性（0-10）：内容是否连续、突变是否过多。\n"
        "- C3 整体观看体验（0-8）：是否易于观看且无明显干扰。\n\n"

        "## 强制扣分/判零规则（非常重要）\n"
        "1) 若帧序列几乎全黑或无有效内容，输出 0。\n"
        "2) 若视频长时间画面静止、内容无效，总分不得超过 60。\n"
        "3) 若严重抖动/虚焦/曝光失败影响大部分内容，总分不得超过 40。\n"
        "4) 若画质优秀、稳定、构图合理且内容清晰：通常应在 80-95 区间；接近满分需要几乎无明显瑕疵。\n\n"

        "请先在心中按 A/B/C 各子项打分并加权汇总，再输出最终的 0-100 整数。"
    )

    messages = [
        {
            "role": "system",
            "content": system_prompt
        },
        {
            "role": "user",
            "content": [
                {
                    "type": "text",
                    "text": user_text_content
                },
                *[
                    {"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{frame}"}}
                    for frame in frames
                ]
            ]
        }
    ]

    return messages



def genrobot_video_prompt(frames):
    """
    给 Qwen3VL 的机器人视频质量评估 Prompt（抽帧输入）
    重点区分：长时间画面不动/等待/卡住（尤其开头结尾）
    最终只输出 0-100 整数
    """
    fps = 2  
    n = len(frames)
    approx_seconds = n / float(fps) if fps else n
    still_2s_frames = max(1, int(round(2 * fps))) 

    system_prompt = (
        "# Role: 机器人操作视频质量评估专家 (Robot Manipulation Video Quality Evaluator)\n\n"
        "你是一名资深机器人操作评估专家和计算机视觉工程师。\n"
        "输入是一组按时间顺序采样的手腕相机视频帧（同一段视频）。你需要给出该视频的动作有效性评分。\n\n"
        "【最重要目标】\n"
        "1) 严格识别：视频中任何位置出现的“>=2秒 画面几乎纹丝不动”的无效静止段（尤其是相机放置在桌面导致的完全静止）。\n"
        "2) 同时要避免误伤：双手协作时，某只手短暂停滞等待（通常<=2秒），但画面边缘/局部仍能看到另一只手在操作，这种应视为有效过程。\n\n"
        "## 严格输出限制\n"
        "1. 最终输出只能是一个 0 到 100 的整数。\n"
        "2. 严禁输出任何解释、文字、前缀或标点。\n"
        "3. 如果帧序列几乎全黑、严重遮挡、无法辨认机器人与任务对象，直接输出 0。\n"
    )
    
    user_text_content = (
        f"你将收到按时间顺序采样的视频帧（fps={fps}，共{n}帧，约{approx_seconds:.1f}秒）。\n"
        "请将这些帧视为同一段机器人手腕相机视频，并输出 0-100 的整数评分。\n\n"
        "====================\n"
        "评分方式：从 100 分开始按规则扣分，最后裁剪到 [0,100] 并输出整数。\n"
        "你必须重点检查“画面是否纹丝不动”的时间段，并区分协作等待 vs 无效静止/相机放置。\n"
        "====================\n\n"
        "【Step 0：直接 0 分】\n"
        "若满足任一条件，直接输出 0：\n"
        "A. >80% 帧几乎全黑/曝光极端异常；\n"
        "B. >80% 帧严重遮挡或极端模糊，无法辨认机器人与任务对象；\n"
        "C. 绝大多数帧不可用，无法判断是否在执行任务。\n\n"
        "【Step 1：把“静止段”分三类（关键）】\n"
        "请在心里对连续帧进行分段，识别“画面变化程度”。重点关注是否存在连续多帧几乎没有任何变化。\n\n"
        "1) 协作等待型短停滞（应尽量不扣分）：\n"
        f"   - 定义：连续静止帧数 < {still_2s_frames}（即 <2秒），并且能看到以下任意证据表明任务仍在推进：\n"
        "     a) 画面边缘/局部（例如左/右边缘）有另一只机械臂/夹爪在运动；\n"
        "     b) 目标物/环境有局部变化（哪怕主体手腕视角变化不大）；\n"
        "     c) 虽然主体几乎不动，但另一只手在操作导致局部区域明显变化。\n"
        "   - 处理：这类不算无效帧，不应因为“主体停住”而扣大分。\n\n"
        "2) 无效静止段（重罚）：\n"
        f"   - 定义：连续静止帧数 >= {still_2s_frames}（>=2秒），且几乎看不到任何机械臂/目标/环境的局部运动证据。\n"
        "   - 特征：画面整体几乎完全一致，机器人看起来在等待且没有进展。\n\n"
        "3) 相机放置/搁置导致的完全静止（最重罚，任何位置都算，包括中间）：\n"
        f"   - 定义：连续静止帧数 >= {still_2s_frames}（>=2秒），并且满足以下强特征中的多项：\n"
        "     a) 背景/桌面纹理几乎完全一致、视角稳定像被放在桌面；\n"
        "     b) 机器人手/夹爪不在工作区或长时间不出现，或出现但完全静止；\n"
        "     c) 看不到任何与任务相关的交互进展（没有接触、抓取、搬运等迹象）。\n"
        "   - 处理：这比一般无效静止更严重。\n\n"
        "【Step 2：扣分规则（围绕 >=2秒 静止段）】\n"
        "只对 Step1 的第2类与第3类进行主要扣分；第1类（协作等待<=2秒且有边缘动作证据）不作为重扣依据。\n\n"
        "A) 一般无效静止段（第2类）按“最长静止段时长 L”扣分：\n"
        "   - L >= 20秒：扣 85\n"
        "   - L >= 10秒：扣 65\n"
        "   - L >= 5 秒：扣 40\n"
        "   - L >= 2 秒：扣 20\n"
        "   额外规则：除最长段外，每新增一段 L>=5秒 的无效静止，再扣 15。\n\n"
        "B) 相机放置/搁置静止（第3类）按“最长搁置段时长 R”扣分（更重）：\n"
        "   - R >= 20秒：直接输出 0（认为视频基本不可用）\n"
        "   - R >= 10秒：扣 90\n"
        "   - R >= 5 秒：扣 60\n"
        "   - R >= 2 秒：扣 35\n"
        "   额外规则：若出现 2 段及以上搁置段（每段>=2秒），再额外扣 20。\n\n"
        "【Step 3：占比规则（辅助，不要覆盖上面的段规则）】\n"
        "计算无效帧占比 P_invalid：包含第2类无效静止、第3类搁置、黑屏/遮挡/极端模糊等。\n"
        "注意：第1类协作等待（<=2秒且有边缘动作证据）不应计入无效帧。\n"
        "   - P_invalid > 20%：扣 50\n"
        "   - P_invalid > 10%：扣 25\n\n"
        "【Step 4：轻微扣分项（总计不超过 20 分）】\n"
        "A) 普遍模糊/对焦差：明显影响判断时扣 5-20（按严重程度）。\n"
        "B) 无意义手臂动作：空挥、来回摆动但无交互进展，扣 5-15。\n"
        "C) 抖动/运动模糊：影响识别但仍可用，扣 5-10。\n\n"
        "【最终输出】\n"
        "只输出最终分数的整数（0-100），不要输出任何其他字符。\n"
    )
    
    # 在每帧前插入 Frame 标记，帮助模型更好理解“连续段”和“开头/结尾”
    content = [{"type": "text", "text": user_text_content}]
    for i, frame in enumerate(frames):
        content.append({"type": "text", "text": f"Frame {i+1}/{n}"})
        content.append({"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{frame}"}})

    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": content},
    ]
    return messages
